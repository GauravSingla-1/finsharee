<!DOCTYPE html>
<html>
<head>
    <title>FinShare API Test - Working Version</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .service-box { padding: 15px; border-radius: 6px; text-align: center; border: 2px solid #ddd; }
        .service-box.online { background: #d4edda; border-color: #28a745; }
        .service-box.offline { background: #f8d7da; border-color: #dc3545; }
        .service-box.checking { background: #fff3cd; border-color: #ffc107; }
        button { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-size: 12px; border: 1px solid #dee2e6; }
        .token-box { background: #e7f3ff; padding: 15px; border-radius: 4px; margin: 10px 0; word-break: break-all; border: 1px solid #bee5eb; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0; }
        .test-section { margin: 15px 0; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FinShare API Test Dashboard</h1>
            <p>Direct testing of all FinShare microservices</p>
        </div>

        <div class="panel">
            <h3>Service Health Status</h3>
            <button onclick="checkAllServices()" id="checkBtn">Check All Services</button>
            <div id="serviceStatus" class="status-grid"></div>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>Authentication</h3>
                <div class="test-section">
                    <button onclick="testLogin()">Login with Demo Account</button>
                    <button onclick="testUserInfo()" id="userBtn" disabled>Get User Info</button>
                </div>
                <div id="tokenBox" class="token-box" style="display: none;"></div>
                <div id="authResult" class="result"></div>
            </div>

            <div class="panel">
                <h3>API Endpoints</h3>
                <div class="test-section">
                    <button onclick="testGroups()" id="groupsBtn" disabled>Test Groups API</button>
                    <button onclick="testExpenses()" id="expensesBtn" disabled>Test Expenses API</button>
                    <button onclick="testAI()" id="aiBtn">Test AI Service</button>
                    <button onclick="testDashboard()" id="dashBtn" disabled>Test Dashboard</button>
                </div>
                <div id="apiResult" class="result"></div>
            </div>
        </div>

        <div class="panel">
            <h3>Custom API Test</h3>
            <input type="text" id="customUrl" placeholder="API Endpoint (e.g., /api/auth/user)" value="/api/auth/user">
            <select id="customMethod" style="padding: 10px; margin: 5px 0;">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
            <button onclick="testCustom()">Test Endpoint</button>
            <div id="customResult" class="result"></div>
        </div>
    </div>

    <script>
        let authToken = '';
        const BASE_URL = 'http://127.0.0.1:5000';

        function updateResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
        }

        function enableButtons() {
            document.getElementById('userBtn').disabled = false;
            document.getElementById('groupsBtn').disabled = false;
            document.getElementById('expensesBtn').disabled = false;
            document.getElementById('dashBtn').disabled = false;
        }

        async function checkAllServices() {
            const statusDiv = document.getElementById('serviceStatus');
            const checkBtn = document.getElementById('checkBtn');
            
            checkBtn.disabled = true;
            checkBtn.textContent = 'Checking...';
            statusDiv.innerHTML = '';

            const services = [
                { name: 'Auth Backend', port: 5000, path: '/test' },
                { name: 'AI Service', port: 8004, path: '/' },
                { name: 'Group Service', port: 8002, path: '/actuator/health' },
                { name: 'Balance Service', port: 8003, path: '/actuator/health' },
                { name: 'Analytics Service', port: 8005, path: '/actuator/health' },
                { name: 'Notification Service', port: 8006, path: '/actuator/health' }
            ];

            for (const service of services) {
                const box = document.createElement('div');
                box.className = 'service-box checking';
                box.innerHTML = `<strong>${service.name}</strong><br>Port ${service.port}<br>Checking...`;
                statusDiv.appendChild(box);

                try {
                    const response = await fetch(`http://127.0.0.1:${service.port}${service.path}`, {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    
                    // Since we're using no-cors, we can't read the response
                    // But if the fetch doesn't throw an error, the service is likely up
                    box.className = 'service-box online';
                    box.innerHTML = `<strong>${service.name}</strong><br>Port ${service.port}<br><span class="success">✓ Online</span>`;
                } catch (error) {
                    box.className = 'service-box offline';
                    box.innerHTML = `<strong>${service.name}</strong><br>Port ${service.port}<br><span class="error">✗ Offline</span>`;
                }
            }

            checkBtn.disabled = false;
            checkBtn.textContent = 'Check All Services';
        }

        async function testLogin() {
            updateResult('authResult', 'Attempting login...');
            
            try {
                const response = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@finshare.app',
                        password: 'password123'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.token) {
                    authToken = data.token;
                    document.getElementById('tokenBox').style.display = 'block';
                    document.getElementById('tokenBox').innerHTML = `<strong>JWT Token:</strong><br>${authToken}`;
                    updateResult('authResult', `✓ Login successful!\nUser: ${data.user.name}\nEmail: ${data.user.email}`, 'success');
                    enableButtons();
                } else {
                    updateResult('authResult', `Login failed: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                updateResult('authResult', `Login error: ${error.message}`, 'error');
            }
        }

        async function testUserInfo() {
            if (!authToken) {
                updateResult('authResult', 'Please login first', 'error');
                return;
            }

            updateResult('authResult', 'Getting user info...');
            
            try {
                const response = await fetch(`${BASE_URL}/api/auth/user`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                updateResult('authResult', `User Info Response (${response.status}):\n${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                updateResult('authResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testGroups() {
            if (!authToken) {
                updateResult('apiResult', 'Please login first', 'error');
                return;
            }

            updateResult('apiResult', 'Testing groups API...');
            
            try {
                const response = await fetch(`${BASE_URL}/api/groups`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                updateResult('apiResult', `Groups API Response (${response.status}):\n${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                updateResult('apiResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testExpenses() {
            if (!authToken) {
                updateResult('apiResult', 'Please login first', 'error');
                return;
            }

            updateResult('apiResult', 'Testing expenses API...');
            
            try {
                const response = await fetch(`${BASE_URL}/api/expenses`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                updateResult('apiResult', `Expenses API Response (${response.status}):\n${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                updateResult('apiResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testAI() {
            updateResult('apiResult', 'Testing AI categorization...');
            
            try {
                const response = await fetch(`${BASE_URL}/api/ai/categorize`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({
                        description: 'Coffee at Starbucks',
                        amount: 6.50
                    })
                });

                const data = await response.json();
                updateResult('apiResult', `AI Service Response (${response.status}):\n${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                updateResult('apiResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testDashboard() {
            if (!authToken) {
                updateResult('apiResult', 'Please login first', 'error');
                return;
            }

            updateResult('apiResult', 'Testing dashboard API...');
            
            try {
                const response = await fetch(`${BASE_URL}/api/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                updateResult('apiResult', `Dashboard API Response (${response.status}):\n${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                updateResult('apiResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testCustom() {
            const url = document.getElementById('customUrl').value;
            const method = document.getElementById('customMethod').value;
            
            if (!url) {
                updateResult('customResult', 'Please enter an endpoint', 'error');
                return;
            }

            updateResult('customResult', `Testing ${method} ${url}...`);
            
            try {
                const options = {
                    method: method,
                    headers: {}
                };

                if (authToken) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                }

                if (method === 'POST' || method === 'PUT') {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify({ test: 'data' });
                }

                const response = await fetch(`${BASE_URL}${url}`, options);
                const data = await response.json();
                updateResult('customResult', `Custom API Response (${response.status}):\n${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                updateResult('customResult', `Error: ${error.message}`, 'error');
            }
        }

        // Auto-check services on load
        window.onload = function() {
            checkAllServices();
        };
    </script>
</body>
</html>